@using TourOperator.Extensions
@using TourOperator.Models.Entities
@model TourOperator.Models.Entities.Report?

@{
    ViewData["Title"] = "Report";

    DateTime fromDate;
    DateTime toDate;
    DateTime now = DateTime.Now;

    Dictionary<DateTime, List<Booking>>? bookingsByDate = null;

    Dictionary<Room, int>? defaultRoomAvailability = null;
    
    if (Model != null){
        fromDate = Model.FromDate;
        toDate = Model.ToDate;

        bookingsByDate = new Dictionary<DateTime, List<Booking>>();

        for (var day = fromDate; day.Date <= toDate; day = day.AddDays(1)){
            bookingsByDate.Add(day, new List<Booking>());
        }

        foreach(Booking booking in Model.Bookings)
        {
            for (var day = booking.StartDate(); day.Date <= booking.EndDate(); day = day.AddDays(1)){
                bookingsByDate[day].Add(booking);
            }
        }
    }
    else{
        fromDate = now;
        toDate = now;
    }

    void PrintRoomAvailability(Report.Availability<Room> roomAvailability)
    {
        <p>Rooms</p>
        <ul>
            @foreach(var availability in roomAvailability){
                <li>
                    @availability.Key.Hotel.Name @@ @availability.Key.Name => @availability.Value places
                </li>
            }
        </ul> 
    }
    
    void PrintTourAvailability(Report.Availability<Tour> tourAvailability)
    {
        <p>Tours</p>
        <ul>
            @foreach(var availability in tourAvailability){
                <li>
                    @availability.Key.Name => @availability.Value places
                </li>
            }
        </ul> 
    }
}

<div class="text-center">
    <h1 class="display-4">Report</h1>
    
    @using (Html.BeginForm("GenerateReport", "View", FormMethod.Post))
    {
        <label for="from">From</label>
        <input type="date" name="FromDate" id="from" class="form-control" value="@fromDate.ToShortDate()" min="@now.ToShortDate()"/>
        
        <label for="to">To</label>
        <input type="date" name="ToDate" id="to" class="form-control" value="@toDate.ToShortDate()" min="@now.ToShortDate()" />
        
        <button type="submit" class="btn btn-primary">Generate</button>
    }
    
    @if (Model != null){
        
        <table>
            <tr>
                <th>Date</th>
                <th>Bookings</th>
            </tr>
            
            @if (bookingsByDate != null){
                foreach(var bookings in bookingsByDate) {
                    <tr>
                        <td>
                            @bookings.Key.ToShortDate()
                        </td>

                        <td>
                            @if (bookings.Value.Any()){
                                {
                                    Report.Availability<Room> roomAvailability = Model.DefaultRoomAvailability?.Duplicate() ?? new();
                                    Report.Availability<Tour> tourAvailability = Model.DefaultTourAvailability?.Duplicate() ?? new();
                                    
                                    foreach(var booking in bookings.Value){
                                            if (booking.HasTour()){
                                                tourAvailability[booking.TourBooking!.Tour] -= 1;
                                            }
                                            
                                            if (booking.HasRoom()){
                                                roomAvailability[booking.RoomBooking!.Room] -= 1;
                                            }
                                    }
                                    
                                    PrintRoomAvailability(roomAvailability);
                                    PrintTourAvailability(tourAvailability);
                                }
                            }
                            else{
                                PrintRoomAvailability(Model.DefaultRoomAvailability);
                                PrintTourAvailability(Model.DefaultTourAvailability);
                            }
                        </td>
                    </tr>
                }
            }
    </table>
    }
</div>